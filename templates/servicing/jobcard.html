{% extends "servicing/base.html" %}
{% load static %}

{% block body %}

    <!-- HEADER -->
    <div class="card-header">
        <div class="w-100 h-100 d-flex flex-wrap">

            <div class="w-75 h-100 d-flex flex-wrap">
                <button onclick="location.href='{% url 'newjob' %}'" style="margin-right: .2em" class="btn btn-outline-primary"><i class="fa fa-plus"></i> new service</button>
                <button onclick="if(confirm('ARE YOU SURE?')){deleteJobCard(this.value)}" id="delete" style="margin-right: .2em" class="btn btn-outline-danger"><i class="fa fa-trash"></i> delete</button>
                <button onclick="if(confirm('ARE YOU SURE YOU WANT TO CLOSE SERVICE?')){updateDocument(this.value,2)}" id="close" style="margin-right: .2em" class="btn btn-outline-warning"><i class="fa fa-door-closed"></i> close</button>
                <button id="update" onclick="ticket.updateTranScreen(this.value)" style="margin-right: .2em" class="btn btn-outline-info"><i class="fa fa-assistive-listening-systems"></i> update ticket</button>
                <button id="send_to_client" onclick="ticket.sendToClient($('#delete').val())" style="margin-right: .2em" class="btn btn-outline-info"><i class="fa fa-mail-bulk"></i> send client</button>
                <button onclick="windowPopUp(`/servicing/jobcard/tracking/${$('#delete').val()}/`,'none',500,1024)" class="btn btn-info"><i class="fa fa-list"></i></button>
            </div>
            <div class="w-25 h-100 d-flex flex-wrap justify-content-end">
                 <button id="prev" onclick="loadJobCard(this.value)" style="margin-right: .2em" class="btn btn-outline-info"><i class="bi bi-skip-backward-btn"></i></button>
                <button id="next" onclick="loadJobCard(this.value)" style="margin-right: .2em" class="btn btn-outline-info"><i class="bi bi-skip-forward-btn"></i></button>
            </div>

        </div>
    </div>

    <!-- BODY -->
    <div class="card-body p-2 overflow-auto">
        <div class="container h-100">
            <div class="row h-100 no-gutters">
                <!-- CLIENT DETAILS -->
                <div class="col-sm-4">
                    <div class="card">
                        <div class="card-header"><strong class="card-title">Client</strong></div>
                        <div class="card-body p-2">
                            <!-- NAME -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">NAME</small>
                                </div>
                                <input required readonly type="text" class="form-control rounded-0 form-control-sm" id="client_name">
                            </div>

                            <!-- EMAIL -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">EMAIL</small>
                                </div>
                                <input required readonly  type="email" class="form-control rounded-0 form-control-sm" id="client_email">
                            </div>

                            <!-- CONTACT -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">PHON</small>
                                </div>
                                <input type="tel" required readonly  class="form-control rounded-0 form-control-sm" id="client_phone">
                            </div>


                        </div>
                    </div>
                </div>

                <!-- SERVICE DETAILS -->
                <div class="col-sm-4">
                    <div class="card">
                        <div class="card-header"><strong class="card-title">Service Details</strong></div>
                        <div class="card-body p-2">
                            <!-- NAME -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">SERVICE MAST</small>
                                </div>
                                <input required readonly  type="text" class="form-control rounded-0 form-control-sm" id="service">
                            </div>

                            <!-- EMAIL -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">SERVICE SUB</small>
                                </div>
                                <input required readonly  type="email" class="form-control rounded-0 form-control-sm" id="service_sub">
                            </div>

                            <!-- CONTACT -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">STATUS</small>
                                </div>
                                <input type="text" required readonly value="" class="form-control rounded-0 form-control-sm" id="status">
                            </div>


                        </div>
                    </div>
                </div>

                <!-- TECHNICIAN -->
                <div class="col-sm-4">
                    <div class="card">
                        <div class="card-header"><strong class="card-title">TECHNICAL</strong></div>
                        <div class="card-body p-2">
                            <!-- NAME -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">ASSIGNED TO.</small>
                                </div>
                                <input required readonly type="text" class="form-control rounded-0 form-control-sm" id="technician">
                            </div>

                            <!-- CONTACT -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">PHON</small>
                                </div>
                                <input type="tel" required readonly  class="form-control rounded-0 form-control-sm" id="techphone">
                            </div>

                            <!-- EMAIL -->
                            <div class="input-group imput-group-sm mb-2">
                                <div class="input-group-prepend rounded-0">
                                    <small class="input-group-text rounded-0">LEVEL</small>
                                </div>
                                <input required readonly type="email" class="form-control rounded-0 form-control-sm" id="level">
                            </div>




                        </div>
                    </div>
                </div>

                <!-- TRANSACTIONS -->
                <div style="height: 60%" class="col-sm-12">
                    <div class="card h-100">
                        <div class="card-header p-2">
                            <!-- Nav pills -->
                            <ul class="nav nav-pills">
                              <li class="nav-item">
                                <a class="nav-link active" data-toggle="pill" href="#home">TRANSACTIONS</a>
                              </li>
                              <li class="nav-item">
                                <a class="nav-link" data-toggle="pill" href="#menu1">MATERIALS</a>
                              </li>
                            </ul>
                        </div>
                        <div class="card-body p-2">


                            <!-- Tab panes -->
                            <div class="tab-content">
                              <div class="tab-pane container active" id="home">
                                  <table class="table table-sm table-bordered table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>TITLE</th><th>DESCRIPTION</th><th>BY</th><th>DATE CREATED</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketTrans">

                                </tbody>
                            </table>
                              </div>
                              <div class="tab-pane container fade" id="menu1">
                                  <table class="table table-sm table-bordered table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>LINE</th>
                                        <th>NAME</th>
                                        <th>DESCRIPTION</th>
                                        <th>PRICE</th>
                                        <th>QTY</th>
                                        <th>COST</th>
                                    </tr>
                                </thead>
                                <tbody id="materialRows">

                                </tbody>
                            </table>
                              </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        console.log(`CARD: NO {{ cardno }}`)
        function loadJobCard(cardno){
            let payload = {
                module:'servicecard',
                data:{
                    cardno:cardno
                }
            };

            let request = api.call('VIEW',payload,'/servicing/api/');
            if(request['status_code'] === 200){
                $('#close').val(cardno)
                let service = request['message'];
                let client = service['client'];
                let materials = service['materials'];
                let next = service['next'];
                let owner = service['owner'];
                let prev = service['prev'];
                let srvice = service['service']['main'];
                let subservice = service['service']['sub'];
                let technician = service['technician'];
                let ticket = service['ticket'];
                let timedata = service['timedata'];

                // html modifications
                if(next['count'] > 0){
                    $('#next').prop('disabled',false);
                    $('#next').val(next['nextcode']);
                } else {
                    $('#next').prop('disabled',true);
                }
                if(prev['count'] > 0){
                    $('#prev').prop('disabled',false);
                    $('#prev').val(prev['code']);
                } else {
                    $('#prev').prop('disabled',true);
                }

                if(service['status'] === 0 || service['status'] === 2){
                    // disabled delete
                    $('#delete').prop('disabled',true);
                    $('#update').prop('disabled',true);
                    $('#close').prop('disabled',true);
                    $('#send_to_client').prop('disabled',true);


                } else if (service['status'] === 1 ){
                    $('#delete').prop('disabled',false);
                    $('#update').prop('disabled',false);
                    $('#close').prop('disabled',false);
                    $('#send_to_client').prop('disabled',false);
                }
                $('#delete').val(cardno)

                $('#client_name').val(client['fullname']);
                $('#client_email').val(client['email']);
                $('#client_phone').val(client['phone'])

                // service
                $('#service').val(srvice['name']);
                $('#service_sub').val(subservice['name']);
                if(service['status'] === 1){
                    $('#status').val("OPEN")
                    $('#status').removeClass('text-success')
                    $('#status').removeClass('text-danger')
                    $('#status').removeClass('text-warning')
                    $('#status').addClass('text-info')
                } else if (service['status'] === 0){
                    $('#status').val("DELETED")
                    $('#status').removeClass('text-warning')
                    $('#status').removeClass('text-success')
                    $('#status').removeClass('text-info')
                    $('#status').addClass('text-danger')
                } else if (service['status'] === 2){
                    $('#status').val("CLOSED")
                    $('#status').removeClass('text-warning')
                    $('#status').removeClass('text-danger')
                    $('#status').removeClass('text-info')
                    $('#status').addClass('text-success')
                } else {
                    $('#status').val("UNKNOWN")
                    $('#status').removeClass('text-success')
                    $('#status').removeClass('text-danger')
                    $('#status').removeClass('text-info')
                    $('#status').addClass('text-warning')

                }


                //technician
                $('#technician').val(technician['fullname']);
                $('#techphone').val(technician['phone']);
                $('#level').val(service['importance'])

                // materials
                let mats = ''
                for (let m = 0; m < materials.length ; m++) {
                    let mat = materials[m]
                    mats += `
                        <tr>
                                        <td>${mat['line']}</td>
                                        <td>${mat['item']}</td>
                                        <td>${mat['description']}</td>
                                        <td>${mat['price']}</td>
                                        <td>${mat['quantity']}</td>
                                        <td>${mat['total_price']}</td>
                                    </tr>
                    `
                }
                $('#materialRows').html(mats);

                $('#update').val(ticket['hd']['pk']);

                // tickets
                let ticket_trans = ticket['trans'];
                let t_rows = '';
                for (let tt = 0; tt < ticket_trans.length; tt++) {
                    let tran = ticket_trans[tt];
                    t_rows += `<tr><td>${tran['title']}</td><td>${tran['descr']}</td><td>${tran['owner']['fullname']}</td><td>${tran['date']}</td></tr>`
                }
                $('#ticketTrans').html(t_rows);

                console.table(service);

            } else {
                alert(request['message'])
            }
        }

        // delete job card
        function deleteJobCard(cardno) {
            updateDocument(cardno,0)

        }

        function updateDocument(cardno,status){
            if(status < 0 || status > 2){
                kasa.error("INVALID SETTINGS")
            } else {
                let payload = {
                module:'jobcardstatus',
                data: {
                    'cardno':cardno,
                    'status':status
                    }
                };
                alert(api.call(
                    'PATCH',payload,'/servicing/api/'
                )['message']);
                loadJobCard(cardno);
            }
        }

        // load first card
        loadJobCard(`{{ cardno }}`)
    </script>

{% endblock %}